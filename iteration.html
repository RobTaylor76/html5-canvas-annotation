<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="js/jquery-1.9.1.min.js"></script>
    <script src="js/RequestAnimationFrame.js"></script>
    <script src="js/ImageResizer.js"></script>
    <script src="js/lineDrawing.js"></script>
    <style>

        .outsideWrapper{

        }
        .insideWrapper{

            position:relative;
        }
        #coveredCanvas{

            position:absolute;
            top:0px;
            left:0px;
            z-index:1;
        }
        .coveringCanvas{
            position:relative;
            z-index:20;
        }

        </style>
</head>
<body>
<h1>Hi</h1>



<script>

    var lineDrawing = new LineDrawing({strokeStyle: "#de000e",lineWidth: 5});

    $(function() {
        createLayout();
        bindEvents();
    });


    function createLayout() {
        var aHTML = [];
        aHTML.push(	'<h2>Select Picture or Take a Photo</h2>' +
            '<div>' +
            '<input accept="image/*" id="takePictureInput" type="file" />' +
            '</div>' +
            '<h2>Annotate on Image</h2>' +
            '<div id="annotationDrawingTools"></div>' +
            '<div id="imageContainer" >' +
            '<img id="yourImageSmall" alt="" />' +
            '</div>' +
            '<div class="outsideWrapper">' +
            '<div class="insideWrapper" id ="insideWrapper">' +
     //       '<img id="loadedImage" class="coveredImage">' +
            '</div>' +
            '</div>' +

            '<button id="combineButton">Combine</button>' +
            '<h2>Final Image</h2>' +
            '<div id="myAnnotationResult"></div>');

        $('body').html(aHTML.join(''));

        $.each(['#000', '#fff', '#ffff00',"#de000e"], function() {
            $('#annotationDrawingTools').append("<a href='#annotationdrawing' data-color='" + this + "' style='background: " + this + "; width: 20px; display:inline-block; text-decoration: none;'>&nbsp;</a> ");

        });
        $.each([1, 3, 6, 9, 12], function() {
            $('#annotationDrawingTools').append("<a href='#annotationdrawing' data-size='" + this + "' style='font-weight: bold; background: #ccc; text-align: center; text-decoration: none;'>" + this + "</a> ");
        });

        $('#annotationDrawingTools').hide();

        $('#annotationDrawingTools a[data-color]').on("click",  function(event) {
            var color = $(event.target).data('color');
            lineDrawing.setColor(color);
        });

        $('#annotationDrawingTools a[data-size]').on("click",  function(event) {
            var size = $(event.target).data('size');
            lineDrawing.setLineWidth(size);
        });

        $('#annotationDrawingTools').append("<a href='#annotationdrawing' id='resetCanvas'>Reset</a> ");

            $("#resetCanvas").on("click",  function(event) {
            lineDrawing.clearCanvas();
        });


    }


    function drawCanvases(canvas) {
//'<img id="loadedImage" class="coveredImage">' +
        canvas.id = "coveredCanvas";
       // canvas.class = "coveredImage";

        $('#insideWrapper').append(canvas);

        $("#coverCanvas").remove(); // replace the canvas if it exists ...
        $('#combineCanvas').remove();

        var coverCanvas = $("<canvas id='coverCanvas'>")
            .attr({
                width: canvas.width,
                height: canvas.height
            })
            .addClass('coveringCanvas');

        $('#insideWrapper').append(coverCanvas);

        lineDrawing.attachToCanvas(coverCanvas.get(0));

        $('#annotationDrawingTools').show();
    }

//    function drawCoverCanvas(dataURL) {
//
//        var imageObj = new Image();
//        imageObj.onload = function() {
//
//            $('#loadedImage').attr('src', dataURL);
//
//            $("#coverCanvas").remove(); // replace the canvas if it exists ...
//            $('#combineCanvas').remove();
//
//            var canvas = $("<canvas id='coverCanvas'>")
//                .attr({
//                    width: imageObj.width,
//                    height: imageObj.height
//                })
//                .addClass('coveringCanvas');
//
//            $('#insideWrapper').append(canvas);
//
//            lineDrawing.attachToCanvas(canvas.get(0));
//
//            $('#annotationDrawingTools').show();
//        };
//        imageObj.src = dataURL;
//    }

    function bindEvents() {
        $('body').on("change", "#takePictureInput", function(event){
            var f = event.target.files[0];
    //        resetFields();

            // Only process image files.
            if(!f.type.match('image.*')) {

            }
            else {

                $("#combineCanvas").remove();
                $("#coveredCanvas").remove();
                $("#coverCanvas").remove();

                var resizer = new ImageResizer({
                    maxWidth: 1024,
                    quality: 0.90,
                    //timeout: 5000,
                    debug : true
                });
                resizer.handleFileSelection(f, drawCanvases);
            }
        });
    }

    $('body').on("click", "#combineButton", function(event) {

        $("#combineCanvas").remove(); // replace the canvas if it exists ...

        var coveredCanvas = $("#coveredCanvas")[0];

        var canvas = $("<canvas id='combineCanvas'>").attr({
            width: coveredCanvas.width,
            height: coveredCanvas.height
        })[0];

        var context = canvas.getContext("2d");

        context.drawImage(coveredCanvas, 0, 0);

        var coverCanvas = $("#coverCanvas")[0];

        context.drawImage(coverCanvas, 0, 0);

        $('#myAnnotationResult').append(canvas);

    });



</script>

</body>
</html>
