<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="js/jquery-1.9.1.min.js"></script>
    <script src="js/RequestAnimationFrame.js"></script>
    <script src="js/ImageResizer.js?id=2"></script>
    <script src="js/lineDrawing.js?id=2"></script>
    <style>

        .outsideWrapper{

        }
        .insideWrapper{

            position:relative;
        }
        #coveredCanvas{

            position:absolute;
            top:0px;
            left:0px;
            z-index:1;
        }
        .coveringCanvas{
            position:relative;
            z-index:20;
        }

        </style>
</head>
<body>
<h1>Hi</h1>



<script>

    var lineDrawing = new LineDrawing({strokeStyle: "#de000e",lineWidth: 3});

    $(function() {
        createLayout();
        bindEvents();
    });


    function createLayout() {
        var aHTML = [];
        aHTML.push(	'<h2>Select Picture or Take a Photo</h2>' +
            '<div>' +
            '<input accept="image/*" id="takePictureInput" type="file" />' +
            '</div>' +
            '<h2>Annotate on Image</h2>' +
            '<div id="annotationDrawingTools">' +
            '<button id="clockwise">Rotate right</button>' +
            '<button id="counterclockwise">Rotate left</button>' +
            '</div>' +
            '<div id="imageContainer" >' +
            '<img id="yourImageSmall" alt="" />' +
            '</div>' +
            '<div class="outsideWrapper">' +
            '<div class="insideWrapper" id ="insideWrapper">' +
     //       '<img id="loadedImage" class="coveredImage">' +
            '</div>' +
            '</div>' +

            '<button id="combineButton">Combine</button>' +
            '<h2>Final Image</h2>' +
            '<div id="myAnnotationResult"></div>'
        );


        aHTML.push(	' <form enctype="multipart/form-data" method="post" name="fileinfo">' +
            ' <label>Your email address:</label>' +
        '<input type="email" autocomplete="on" autofocus name="userid" placeholder="email" required size="32" maxlength="64" /><br />' +
        '<label>Custom file label:</label>' +
        '<input type="text" name="filelabel" size="12" maxlength="32" /><br />' +
        '<label>File to stash:</label>' +
        '</form>' +
            '<div id="output"></div>'+
        '<a href="javascript:sendForm()">Stash the file!</a>'
        );

        $('body').html(aHTML.join(''));

        $.each(['#000', '#fff', '#ffff00',"#de000e"], function() {
            $('#annotationDrawingTools').append("<a href='#annotationdrawing' data-color='" + this + "' style='background: " + this + "; width: 20px; display:inline-block; text-decoration: none;'>&nbsp;</a> ");

        });
        $.each([1, 3, 5], function() {
            $('#annotationDrawingTools').append("<a href='#annotationdrawing' data-size='" + this + "' style='font-weight: bold; background: #ccc; text-align: center; text-decoration: none;'>" + this + "</a> ");
        });

        $('#annotationDrawingTools').hide();

        $('#annotationDrawingTools a[data-color]').on("click",  function(event) {
            var color = $(event.target).data('color');
            lineDrawing.setColor(color);
        });

        $('#annotationDrawingTools a[data-size]').on("click",  function(event) {
            var size = $(event.target).data('size');
            lineDrawing.setLineWidth(size);
        });

        $('#annotationDrawingTools').append("<a href='#annotationdrawing' id='resetCanvas'>Reset</a> ");

            $("#resetCanvas").on("click",  function(event) {
            lineDrawing.clearCanvas();
        });

        $("#clockwise").click(function(){
 //           angleInDegrees+=90 % 360;
            drawRotated(90);
        });

        $("#counterclockwise").click(function(){
//            if(angleInDegrees == 0)
//                angleInDegrees = 270;
//            else
//                angleInDegrees-=90 % 360;
            drawRotated(270);
        });
    }


    function drawCanvases(canvas) {

        $("#coveredCanvas").remove(); // replace the canvas if it exists ...
        $("#coverCanvas").remove(); // replace the canvas if it exists ...
        $('#combineCanvas').remove();

        //'<img id="loadedImage" class="coveredImage">' +
        canvas.id = "coveredCanvas";

        $('#insideWrapper').append(canvas);

        var coverCanvas = $("<canvas id='coverCanvas'>")
            .attr({
                width: canvas.width,
                height: canvas.height
            })
            .addClass('coveringCanvas');

        $('#insideWrapper').append(coverCanvas);

        lineDrawing.attachToCanvas(coverCanvas.get(0));

        $('#annotationDrawingTools').show();
    }

//    function drawCoverCanvas(dataURL) {
//
//        var imageObj = new Image();
//        imageObj.onload = function() {
//
//            $('#loadedImage').attr('src', dataURL);
//
//            $("#coverCanvas").remove(); // replace the canvas if it exists ...
//            $('#combineCanvas').remove();
//
//            var canvas = $("<canvas id='coverCanvas'>")
//                .attr({
//                    width: imageObj.width,
//                    height: imageObj.height
//                })
//                .addClass('coveringCanvas');
//
//            $('#insideWrapper').append(canvas);
//
//            lineDrawing.attachToCanvas(canvas.get(0));
//
//            $('#annotationDrawingTools').show();
//        };
//        imageObj.src = dataURL;
//    }

    function bindEvents() {
        $('body').on("change", "#takePictureInput", function(event){
            var f = event.target.files[0];
    //        resetFields();

            // Only process image files.
            if(!f.type.match('image.*')) {

            }
            else {

                $("#combineCanvas").remove();
                $("#coveredCanvas").remove();
                $("#coverCanvas").remove();

                var resizer = new ImageResizer({
                    maxWidth: 1024,
                    quality: 0.90,
                    //timeout: 5000,
                    debug : true
                });
                resizer.handleFileSelection(f, drawCanvases);
            }
        });
    }

    $('body').on("click", "#combineButton", function(event) {

        $("#combineCanvas").remove(); // replace the canvas if it exists ...

        var coveredCanvas = $("#coveredCanvas")[0];

        var canvas = $("<canvas id='combineCanvas'>").attr({
            width: coveredCanvas.width,
            height: coveredCanvas.height
        })[0];

        var context = canvas.getContext("2d");

        context.drawImage(coveredCanvas, 0, 0);

        var coverCanvas = $("#coverCanvas")[0];

        context.drawImage(coverCanvas, 0, 0);

        $('#myAnnotationResult').append(canvas);

    });

    function drawRotated(degrees){
       // if(canvas) document.body.removeChild(canvas);

        canvas = document.createElement("canvas");
        var ctx=canvas.getContext("2d");


        var coveredCanvas = $("#coveredCanvas")[0];


        if(degrees == 90 || degrees == 270) {
            canvas.width = coveredCanvas.height;
            canvas.height = coveredCanvas.width;
        } else {
            canvas.width = coveredCanvas.width;
            canvas.height = coveredCanvas.height;
        }

        ctx.clearRect(0,0,canvas.width,canvas.height);
        if(degrees == 90 || degrees == 270) {
            ctx.translate(coveredCanvas.height/2,coveredCanvas.width/2);
        } else {
            ctx.translate(coveredCanvas.width/2,coveredCanvas.height/2);
        }
        ctx.rotate(degrees*Math.PI/180);
        ctx.drawImage(coveredCanvas,-coveredCanvas.width/2,-coveredCanvas.height/2);

        drawCanvases(canvas);

       // document.body.appendChild(canvas);
    }




    function sendForm() {
        var oOutput = document.getElementById("output");
        var oData = new FormData(document.forms.namedItem("fileinfo"));

        // oData.append("CustomField", "This is some extra data");

        // oData.append("myfile", stylesblob);

        var canvas = $('#combineCanvas')[0];
        var durl = canvas.toDataURL('image/jpeg', 1.0);
      // var dataURL = canvas.toDataURL('image/jpeg', 0.5);

        var blob = dataURItoBlob(durl);
        var fd = new FormData(document.forms[0]);
        oData.append("canvasImage", blob);


        var oReq = new XMLHttpRequest();
        oReq.open("POST", "/styleStore", true);
        oReq.onload = function(oEvent) {
            if (oReq.status == 200) {
                oOutput.innerHTML = "Uploaded!";
            } else {
                oOutput.innerHTML = "Error " + oReq.status + " occurred uploading your file.<br \/>";
            }
        };

        oReq.send(oData);
    }


    function dataURItoBlob(dataURI) {
        // convert base64 to raw binary data held in a string
        // convert base64/URLEncoded data component to raw binary data held in a string
        var byteString;
        if (dataURI.split(',')[0].indexOf('base64') >= 0)
            byteString = atob(dataURI.split(',')[1]);
        else
            byteString = unescape(dataURI.split(',')[1]);

        // separate out the mime component
        var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0]

        // write the bytes of the string to an ArrayBuffer
        var ab = new ArrayBuffer(byteString.length);
        var ia = new Uint8Array(ab);
        for (var i = 0; i < byteString.length; i++) {
            ia[i] = byteString.charCodeAt(i);
        }

        // write the ArrayBuffer to a blob, and you're done
        // var bb = new BlobBuilder();
        // bb.append(ab);
        // return bb.getBlob(mimeString);

        var bb = new Blob([ab], {type: mimeString});
        return bb;
    }


</script>

</body>
</html>
